{% extends "base.html" %}
{% block content %}
<div class="container">
<div class="stats-grid" id="stats">
<div class="stat-card"><h3>Total Images</h3><div class="stat-value" id="total-images">-</div></div>
<div class="stat-card"><h3>Storage Used</h3><div class="stat-value" id="total-storage">-</div></div>
<div class="stat-card"><h3>Rated Images</h3><div class="stat-value" id="rated-images">-</div></div>
<div class="stat-card"><h3>With GPS</h3><div class="stat-value" id="gps-images">-</div></div>
</div>
<div class="filters">
<div class="filter-grid">
<div class="filter-group"><label for="rating-min">Min Rating</label><select id="rating-min"><option value="">Any</option><option value="1">1★</option><option value="2">2★</option><option value="3">3★</option><option value="4">4★</option><option value="5">5★</option></select></div>
<div class="filter-group"><label for="camera">Camera</label><select id="camera"><option value="">All Cameras</option></select></div>
<div class="filter-group"><label for="year">Year</label><select id="year"><option value="">All Years</option></select></div>
<div class="filter-group"><label for="media-type">Type</label><select id="media-type"><option value="">All Types</option></select></div>
<div class="filter-group"><label for="has-gps">GPS</label><select id="has-gps"><option value="">Any</option><option value="true">With GPS</option></select></div>
</div>
<button onclick="applyFilters()">Apply Filters</button>
<button onclick="resetFilters()" style="background: #666; margin-left: 0.5rem;">Reset</button>
<div style="display: inline-block; margin-left: 1rem;">
<select id="export-format" style="padding: 0.5rem; background: #2a2a2a; color: #eee; border: 1px solid #444;">
<option value="json">JSON (IDs)</option>
<option value="txt">Text (Paths)</option>
</select>
<button onclick="exportFiltered()" style="background: #2a5; margin-left: 0.5rem;">Export</button>
</div>
</div>
<div id="gallery" class="gallery"></div>
<div class="pagination" id="pagination"></div>
</div>
{% endblock %}
{% block extra_js %}
let currentPage=1,filters={};document.addEventListener('DOMContentLoaded',()=>{loadStats();loadFilterOptions();loadImages()});async function loadStats(){try{const response=await fetch('/api/stats'),data=await response.json(),totalImages=data.by_type.reduce((sum,t)=>sum+t.count,0);document.getElementById('total-images').textContent=totalImages.toLocaleString();const totalGB=data.by_type.reduce((sum,t)=>sum+t.gb,0);document.getElementById('total-storage').textContent=totalGB.toFixed(1)+' GB';const ratedCount=data.by_rating.filter(r=>r.rating>=0).reduce((sum,r)=>sum+r.count,0);document.getElementById('rated-images').textContent=ratedCount.toLocaleString();document.getElementById('gps-images').textContent=data.gps_count.toLocaleString()}catch(error){console.error('Error loading stats:',error)}}async function loadFilterOptions(){try{const response=await fetch('/api/filters'),data=await response.json(),cameraSelect=document.getElementById('camera');data.cameras.forEach(camera=>{const option=document.createElement('option');option.value=camera;option.textContent=camera;cameraSelect.appendChild(option)});const yearSelect=document.getElementById('year');data.years.forEach(year=>{const option=document.createElement('option');option.value=year;option.textContent=year;yearSelect.appendChild(option)});const typeSelect=document.getElementById('media-type');data.media_types.forEach(type=>{const option=document.createElement('option');option.value=type;option.textContent=type;typeSelect.appendChild(option)})}catch(error){console.error('Error loading filter options:',error)}}async function loadImages(page=1){currentPage=page;const params=new URLSearchParams({page:page,per_page:50,...filters});try{document.getElementById('gallery').innerHTML='<div class="loading">Loading images...</div>';const response=await fetch(`/api/images?${params}`),data=await response.json(),gallery=document.getElementById('gallery');gallery.innerHTML='';if(data.images.length===0){gallery.innerHTML='<div class="loading">No images found matching your filters</div>';return}data.images.forEach(image=>{const card=document.createElement('div');card.className='image-card';const rating=image.rating?'★'.repeat(image.rating)+'☆'.repeat(5-image.rating):'Not rated';card.innerHTML=`<img src="/api/thumbnail/${image.id}" alt="Image ${image.id}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'250\\' height=\\'200\\'%3E%3Crect fill=\\'%23333\\' width=\\'250\\' height=\\'200\\'/%3E%3Ctext fill=\\'%23666\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' font-family=\\'sans-serif\\'%3ENo Preview%3C/text%3E%3C/svg%3E'"><div class="image-info"><div class="image-rating">${rating}</div><div class="image-meta">${image.camera_make||'Unknown'}<br>${image.width}×${image.height} | ${image.media_type}</div></div>`;gallery.appendChild(card)});renderPagination(data.page,data.pages)}catch(error){console.error('Error loading images:',error);document.getElementById('gallery').innerHTML='<div class="loading">Error loading images. Check console for details.</div>'}}function renderPagination(currentPage,totalPages){const pagination=document.getElementById('pagination');pagination.innerHTML='';const prevBtn=document.createElement('button');prevBtn.textContent='← Previous';prevBtn.disabled=currentPage===1;prevBtn.onclick=()=>loadImages(currentPage-1);pagination.appendChild(prevBtn);const pageInfo=document.createElement('span');pageInfo.textContent=`Page ${currentPage} of ${totalPages}`;pageInfo.style.padding='0.5rem 1rem';pageInfo.style.color='#999';pagination.appendChild(pageInfo);const nextBtn=document.createElement('button');nextBtn.textContent='Next →';nextBtn.disabled=currentPage===totalPages;nextBtn.onclick=()=>loadImages(currentPage+1);pagination.appendChild(nextBtn)}function applyFilters(){filters={};const ratingMin=document.getElementById('rating-min').value;if(ratingMin)filters.rating_min=ratingMin;const camera=document.getElementById('camera').value;if(camera)filters.camera_make=camera;const year=document.getElementById('year').value;if(year)filters.year=year;const mediaType=document.getElementById('media-type').value;if(mediaType)filters.media_type=mediaType;const hasGPS=document.getElementById('has-gps').value;if(hasGPS)filters.has_gps=hasGPS;loadImages(1)}function resetFilters(){document.getElementById('rating-min').value='';document.getElementById('camera').value='';document.getElementById('year').value='';document.getElementById('media-type').value='';document.getElementById('has-gps').value='';filters={};loadImages(1)}async function exportFiltered(){const format=document.getElementById('export-format').value;const params=new URLSearchParams({format:format,...filters});try{const response=await fetch(`/api/export?${params}`);if(!response.ok){alert('Error exporting data: '+response.statusText);return}if(format==='json'){const data=await response.json();const compactJson='{\n  "filter": '+JSON.stringify(data.filter)+',\n  "total_count": '+data.total_count+',\n  "exported_at": "'+data.exported_at+'",\n  "image_ids": '+JSON.stringify(data.image_ids)+'\n}';const blob=new Blob([compactJson],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`export_${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(url)}else{const text=await response.text();const blob=new Blob([text],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`export_${new Date().toISOString().split('T')[0]}.txt`;a.click();URL.revokeObjectURL(url)}}catch(error){console.error('Error exporting:',error);alert('Error exporting data. Check console for details.')}}
{% endblock %}
